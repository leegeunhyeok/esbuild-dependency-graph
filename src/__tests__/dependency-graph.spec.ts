import { readFile } from 'node:fs/promises';
import { join } from 'node:path';
import { describe, it, expect, beforeAll } from 'vitest';
import { DependencyGraph } from '../dependency-graph';
import type { Module } from '../types';

const TEST_MODULE = 'src/screens/MainScreen.tsx';

describe('DependencyGraph', () => {
  let graph: DependencyGraph;

  beforeAll(async () => {
    const rawMetafile = await readFile(
      join(__dirname, './fixtures/metafile.json'),
      'utf-8',
    );
    graph = new DependencyGraph().load(rawMetafile);
  });

  describe('size', () => {
    it('should match snapshot', () => {
      expect(graph.size).toMatchSnapshot();
    });
  });

  describe('dependenciesOf', () => {
    it('should match snapshot', () => {
      expect(graph.dependenciesOf(TEST_MODULE)).toMatchSnapshot();
    });
  });

  describe('dependentsOf', () => {
    it('should match snapshot', () => {
      expect(graph.dependentsOf(TEST_MODULE)).toMatchSnapshot();
    });
  });

  describe('inverseDependenciesOf', () => {
    it('should match snapshot', () => {
      expect(graph.inverseDependenciesOf(TEST_MODULE)).toMatchSnapshot();
    });
  });

  describe('hasModule', () => {
    it('should returns `true` if module exists', () => {
      expect(graph.hasModule('src/screens/MainScreen.tsx')).toBe(true);
    });

    it('should returns `false` if module is not exists', () => {
      expect(graph.hasModule('not/registered/module.ts')).toBe(false);
    });
  });

  describe('addModule', () => {
    beforeAll(() => {
      /**
       * `src/screens/MainScreen.tsx`
       *
       * **Dependencies**
       * - node_modules/react/jsx-runtime.js
       * - node_modules/react/index.js
       * - node_modules/react-native/index.js
       * - node_modules/react-native-safe-area-context/src/index.tsx
       * - node_modules/dripsy/src/index.ts
       * - src/components/index.ts
       * - src/assets/logo.svg
       *
       * **Dependents**
       * - src/screens/index.ts
       *
       * ---
       *
       * **Expected**
       *
       * - index.js
       *   - root/entry.ts
       *     - node_modules/react/index.js
       *     - node_modules/react-native/index.js
       *     - root/screens.ts
       *   - root/screens.ts
       *     - src/screens/MainScreen.tsx
       */
      graph.addModule(
        'root/entry.ts',
        ['node_modules/react/index.js', 'node_modules/react-native/index.js'],
        ['index.js'],
      );
      graph.addModule(
        'root/screens.ts',
        ['src/screens/MainScreen.tsx'],
        ['root/entry.ts'],
      );
    });

    describe('when add new modules', () => {
      function parsePath(module: Module): string {
        return module.path;
      }

      it('should match snapshots', () => {
        const inverseDependencies = graph.inverseDependenciesOf(
          'src/screens/MainScreen.tsx',
        );
        expect(inverseDependencies).toMatchSnapshot();
      });

      it('should be able to retrieve the added dependencies', () => {
        expect(graph.dependenciesOf('root/entry.ts').map(parsePath)).toEqual(
          expect.arrayContaining([
            'node_modules/react/index.js',
            'node_modules/react-native/index.js',
            'root/screens.ts',
          ]),
        );
        expect(graph.dependentsOf('root/entry.ts').map(parsePath)).toEqual(
          expect.arrayContaining(['index.js']),
        );

        // root/screens.ts
        expect(graph.dependenciesOf('root/screens.ts').map(parsePath)).toEqual(
          expect.arrayContaining(['src/screens/MainScreen.tsx']),
        );
        expect(graph.dependentsOf('root/entry.ts').map(parsePath)).toEqual(
          expect.arrayContaining(['index.js']),
        );

        // src/screens/MainScreen.tsx
        const inverseDependencies = graph.inverseDependenciesOf(
          'src/screens/MainScreen.tsx',
        );
        expect(inverseDependencies.map(parsePath)).toContain('root/screens.ts');
        expect(inverseDependencies.map(parsePath)).toContain('root/entry.ts');
      });
    });
  });

  describe('updateModule', () => {
    it('should match snapshots', () => {
      graph.addModule('global.ts');
      graph.addModule('re-export.ts');

      graph.updateModule(
        'src/screens/MainScreen.tsx',
        [
          ...graph
            .dependenciesOf('src/screens/MainScreen.tsx')
            .map(({ id }) => id),
          'global.ts',
        ],
        [
          ...graph
            .dependentsOf('src/screens/MainScreen.tsx')
            .map(({ id }) => id),
          're-export.ts',
        ],
      );

      expect(graph.dependenciesOf('re-export.ts')).toMatchSnapshot();
      expect(graph.dependentsOf('global.ts')).toMatchSnapshot();
      expect(
        graph.inverseDependenciesOf('src/screens/MainScreen.tsx'),
      ).toMatchSnapshot();
    });
  });

  describe('removeModule', () => {
    it('should match snapshot', () => {
      const prevSize = graph.size;

      graph.removeModule('src/screens/index.ts');
      const inverseDependencies = graph.inverseDependenciesOf(
        'src/screens/MainScreen.tsx',
      );
      expect(inverseDependencies).toMatchSnapshot();
      expect(graph.size).toEqual(prevSize - 1);
    });
  });

  describe('lazy load', () => {
    const ROOT = '/root/workspace';
    let graph: DependencyGraph;

    beforeAll(() => {
      graph = new DependencyGraph({ root: ROOT });

      graph.addModule('/root/workspace/index.js', [], []);
      graph.addModule('/root/workspace/src/App.tsx', [], []);
      graph.addModule('/root/workspace/src/screens/MainScreen.tsx', [], []);
    });

    it('should update module data', async () => {
      const indexModule = graph.getModule('/root/workspace/index.js');
      const appModule = graph.getModule('/root/workspace/src/App.tsx');
      const mainScreenModule = graph.getModule(
        '/root/workspace/src/screens/MainScreen.tsx',
      );

      // Before update
      expect(graph.dependenciesOf(indexModule.path)).toHaveLength(0);
      expect(graph.dependenciesOf(appModule.path)).toHaveLength(0);
      expect(graph.dependenciesOf(mainScreenModule.path)).toHaveLength(0);

      const rawMetafile = await readFile(
        join(__dirname, './fixtures/metafile.json'),
        'utf-8',
      );

      // Load after add some modules.
      graph.load(rawMetafile);

      // After update
      expect(graph.dependenciesOf(indexModule.path)).toMatchInlineSnapshot(`
        [
          {
            "dependencies": [
              3,
              20,
              52,
              80,
              107,
              110,
              115,
              147,
              152,
              153,
              175,
              177,
              180,
              201,
              79,
              453,
              125,
            ],
            "dependents": [
              256,
              0,
            ],
            "id": 257,
            "path": "node_modules/react-native/Libraries/Core/InitializeCore.js",
          },
          {
            "dependencies": [
              21,
              35,
              338,
              342,
              381,
              382,
              452,
              390,
              391,
              393,
              394,
              398,
              403,
              340,
              406,
              285,
              400,
              407,
              410,
              413,
              377,
              415,
              419,
              420,
              378,
              379,
              421,
              266,
              422,
              423,
              425,
              151,
              380,
              170,
              453,
              184,
              426,
              428,
              429,
              161,
              213,
              292,
              247,
              271,
              290,
              327,
              325,
              432,
              79,
              150,
              138,
              133,
              434,
              436,
              214,
              438,
              191,
              440,
              267,
              32,
              441,
              41,
              231,
              442,
              445,
              446,
              73,
              448,
              449,
              127,
              450,
              158,
              40,
              60,
              165,
              167,
              277,
              268,
              376,
            ],
            "dependents": [
              454,
              463,
              464,
              465,
              515,
              518,
              548,
              567,
              624,
              633,
              636,
              637,
              638,
              648,
              656,
              658,
              659,
              660,
              674,
              675,
              682,
              683,
              774,
              777,
              779,
              792,
              793,
              807,
              808,
              809,
              811,
              812,
              814,
              815,
              816,
              899,
              900,
              904,
              907,
              987,
              995,
              996,
              1001,
              1002,
              1003,
              1005,
              1006,
              1007,
              1008,
              1009,
              1010,
              1011,
              1012,
              1013,
              1014,
              1016,
              1017,
              1028,
              1031,
              1032,
              1033,
              1034,
              1035,
              1038,
              1039,
              1041,
              1042,
              1047,
              1048,
              1049,
              1050,
              1051,
              1053,
              1054,
              1056,
              1059,
              1060,
              1061,
              1064,
              1067,
              1071,
              1072,
              1073,
              1074,
              1083,
              1085,
              1095,
              1100,
              1109,
              1110,
              1112,
              1113,
              1114,
              1115,
              1116,
              1117,
              1118,
              1127,
              1128,
              1129,
              1130,
              1132,
              1138,
              1160,
              1161,
              1171,
              1177,
              1356,
              2,
              1363,
              0,
            ],
            "id": 451,
            "path": "node_modules/react-native/index.js",
          },
          {
            "dependencies": [
              512,
              76,
              521,
              817,
              917,
              989,
              1046,
              1366,
              1369,
            ],
            "dependents": [
              0,
            ],
            "id": 1,
            "path": "src/App.tsx",
          },
          {
            "dependencies": [],
            "dependents": [
              0,
            ],
            "id": 1370,
            "path": "app.json",
          },
        ]
      `);

      expect(graph.dependenciesOf(appModule.path)).toMatchInlineSnapshot(`
        [
          {
            "dependencies": [
              511,
            ],
            "dependents": [
              515,
              517,
              636,
              658,
              660,
              682,
              683,
              777,
              787,
              793,
              807,
              809,
              810,
              811,
              812,
              814,
              815,
              816,
              829,
              843,
              865,
              874,
              879,
              881,
              890,
              903,
              909,
              911,
              999,
              1003,
              1028,
              1031,
              1033,
              1038,
              1039,
              1041,
              1053,
              1056,
              1059,
              1060,
              1061,
              1064,
              1067,
              1071,
              1072,
              1073,
              1074,
              1079,
              1083,
              1084,
              1085,
              1097,
              1109,
              1110,
              1112,
              1113,
              1114,
              1116,
              1117,
              1118,
              1119,
              1123,
              1124,
              1125,
              1142,
              1144,
              1146,
              1148,
              1150,
              1151,
              1153,
              1155,
              1157,
              1161,
              1163,
              1165,
              1167,
              1169,
              1171,
              1173,
              1175,
              1179,
              1181,
              1184,
              1186,
              1188,
              1190,
              1192,
              1193,
              1355,
              1356,
              2,
              1363,
              1365,
              1,
            ],
            "id": 512,
            "path": "node_modules/react/jsx-runtime.js",
          },
          {
            "dependencies": [
              75,
            ],
            "dependents": [
              77,
              209,
              210,
              240,
              246,
              260,
              262,
              265,
              266,
              268,
              269,
              273,
              274,
              275,
              279,
              280,
              282,
              283,
              285,
              305,
              307,
              311,
              312,
              332,
              333,
              339,
              342,
              347,
              348,
              377,
              378,
              379,
              381,
              383,
              386,
              390,
              391,
              393,
              394,
              398,
              402,
              403,
              404,
              405,
              406,
              407,
              410,
              411,
              412,
              413,
              415,
              419,
              420,
              421,
              442,
              443,
              446,
              449,
              460,
              462,
              463,
              464,
              465,
              452,
              467,
              468,
              469,
              470,
              471,
              472,
              473,
              400,
              476,
              477,
              478,
              481,
              482,
              483,
              484,
              486,
              487,
              490,
              491,
              401,
              492,
              493,
              495,
              496,
              497,
              498,
              501,
              502,
              503,
              506,
              507,
              508,
              509,
              510,
              511,
              515,
              517,
              628,
              636,
              637,
              638,
              641,
              642,
              643,
              644,
              647,
              648,
              650,
              651,
              654,
              655,
              656,
              658,
              659,
              660,
              681,
              682,
              683,
              774,
              777,
              780,
              787,
              793,
              807,
              809,
              810,
              811,
              812,
              814,
              815,
              816,
              829,
              831,
              832,
              833,
              834,
              835,
              836,
              837,
              838,
              839,
              840,
              841,
              842,
              843,
              847,
              849,
              861,
              862,
              863,
              864,
              865,
              867,
              868,
              869,
              874,
              875,
              878,
              879,
              880,
              881,
              882,
              883,
              884,
              885,
              886,
              887,
              888,
              889,
              890,
              891,
              892,
              893,
              894,
              895,
              897,
              898,
              899,
              900,
              902,
              903,
              904,
              907,
              908,
              909,
              910,
              911,
              913,
              915,
              916,
              984,
              985,
              988,
              990,
              991,
              992,
              998,
              999,
              1003,
              1009,
              1010,
              1012,
              1013,
              1014,
              1016,
              1017,
              1027,
              1028,
              1031,
              1033,
              1038,
              1039,
              1041,
              1053,
              1056,
              1057,
              1059,
              1060,
              1061,
              1064,
              1067,
              1070,
              1071,
              1072,
              1073,
              1074,
              1077,
              1078,
              1079,
              1083,
              1084,
              1085,
              1097,
              1098,
              1099,
              1109,
              1110,
              1111,
              1112,
              1113,
              1114,
              1115,
              1116,
              1117,
              1118,
              1119,
              1120,
              1121,
              1123,
              1124,
              1125,
              1130,
              1142,
              1144,
              1146,
              1148,
              1150,
              1151,
              1153,
              1155,
              1157,
              1161,
              1163,
              1165,
              1167,
              1169,
              1171,
              1173,
              1175,
              1177,
              1179,
              1181,
              1182,
              1184,
              1186,
              1188,
              1190,
              1192,
              1193,
              1355,
              1356,
              1361,
              2,
              1363,
              1365,
              1,
            ],
            "id": 76,
            "path": "node_modules/react/index.js",
          },
          {
            "dependencies": [
              515,
              517,
              519,
              520,
            ],
            "dependents": [
              1060,
              1073,
              1074,
              1084,
              1118,
              2,
              1,
            ],
            "id": 521,
            "path": "node_modules/react-native-safe-area-context/src/index.tsx",
          },
          {
            "dependencies": [
              676,
              677,
              522,
              683,
              682,
              778,
              780,
              781,
              782,
              783,
              784,
              785,
              787,
              793,
              804,
              786,
              807,
              813,
              814,
              789,
              815,
              816,
              792,
            ],
            "dependents": [
              1079,
              1,
            ],
            "id": 817,
            "path": "node_modules/react-native-gesture-handler/src/index.ts",
          },
          {
            "dependencies": [
              900,
              897,
              909,
              911,
              912,
              901,
              903,
              913,
              914,
              915,
              899,
              898,
              916,
              896,
            ],
            "dependents": [
              1053,
              1056,
              1059,
              1064,
              1067,
              1074,
              1084,
              1085,
              1112,
              1116,
              1118,
              1119,
              1,
            ],
            "id": 917,
            "path": "node_modules/@react-navigation/native/src/index.tsx",
          },
          {
            "dependencies": [
              985,
              988,
            ],
            "dependents": [
              1,
            ],
            "id": 989,
            "path": "node_modules/@react-navigation/devtools/src/index.tsx",
          },
          {
            "dependencies": [
              1045,
            ],
            "dependents": [
              1123,
              1125,
              2,
              1363,
              1369,
              1,
            ],
            "id": 1046,
            "path": "node_modules/dripsy/src/index.ts",
          },
          {
            "dependencies": [
              1365,
            ],
            "dependents": [
              1,
            ],
            "id": 1366,
            "path": "src/navigators/index.ts",
          },
          {
            "dependencies": [
              54,
              1046,
              1367,
              1368,
            ],
            "dependents": [
              1,
            ],
            "id": 1369,
            "path": "src/theme/index.ts",
          },
        ]
      `);

      expect(graph.dependenciesOf(mainScreenModule.path))
        .toMatchInlineSnapshot(`
          [
            {
              "dependencies": [
                511,
              ],
              "dependents": [
                515,
                517,
                636,
                658,
                660,
                682,
                683,
                777,
                787,
                793,
                807,
                809,
                810,
                811,
                812,
                814,
                815,
                816,
                829,
                843,
                865,
                874,
                879,
                881,
                890,
                903,
                909,
                911,
                999,
                1003,
                1028,
                1031,
                1033,
                1038,
                1039,
                1041,
                1053,
                1056,
                1059,
                1060,
                1061,
                1064,
                1067,
                1071,
                1072,
                1073,
                1074,
                1079,
                1083,
                1084,
                1085,
                1097,
                1109,
                1110,
                1112,
                1113,
                1114,
                1116,
                1117,
                1118,
                1119,
                1123,
                1124,
                1125,
                1142,
                1144,
                1146,
                1148,
                1150,
                1151,
                1153,
                1155,
                1157,
                1161,
                1163,
                1165,
                1167,
                1169,
                1171,
                1173,
                1175,
                1179,
                1181,
                1184,
                1186,
                1188,
                1190,
                1192,
                1193,
                1355,
                1356,
                2,
                1363,
                1365,
                1,
              ],
              "id": 512,
              "path": "node_modules/react/jsx-runtime.js",
            },
            {
              "dependencies": [
                75,
              ],
              "dependents": [
                77,
                209,
                210,
                240,
                246,
                260,
                262,
                265,
                266,
                268,
                269,
                273,
                274,
                275,
                279,
                280,
                282,
                283,
                285,
                305,
                307,
                311,
                312,
                332,
                333,
                339,
                342,
                347,
                348,
                377,
                378,
                379,
                381,
                383,
                386,
                390,
                391,
                393,
                394,
                398,
                402,
                403,
                404,
                405,
                406,
                407,
                410,
                411,
                412,
                413,
                415,
                419,
                420,
                421,
                442,
                443,
                446,
                449,
                460,
                462,
                463,
                464,
                465,
                452,
                467,
                468,
                469,
                470,
                471,
                472,
                473,
                400,
                476,
                477,
                478,
                481,
                482,
                483,
                484,
                486,
                487,
                490,
                491,
                401,
                492,
                493,
                495,
                496,
                497,
                498,
                501,
                502,
                503,
                506,
                507,
                508,
                509,
                510,
                511,
                515,
                517,
                628,
                636,
                637,
                638,
                641,
                642,
                643,
                644,
                647,
                648,
                650,
                651,
                654,
                655,
                656,
                658,
                659,
                660,
                681,
                682,
                683,
                774,
                777,
                780,
                787,
                793,
                807,
                809,
                810,
                811,
                812,
                814,
                815,
                816,
                829,
                831,
                832,
                833,
                834,
                835,
                836,
                837,
                838,
                839,
                840,
                841,
                842,
                843,
                847,
                849,
                861,
                862,
                863,
                864,
                865,
                867,
                868,
                869,
                874,
                875,
                878,
                879,
                880,
                881,
                882,
                883,
                884,
                885,
                886,
                887,
                888,
                889,
                890,
                891,
                892,
                893,
                894,
                895,
                897,
                898,
                899,
                900,
                902,
                903,
                904,
                907,
                908,
                909,
                910,
                911,
                913,
                915,
                916,
                984,
                985,
                988,
                990,
                991,
                992,
                998,
                999,
                1003,
                1009,
                1010,
                1012,
                1013,
                1014,
                1016,
                1017,
                1027,
                1028,
                1031,
                1033,
                1038,
                1039,
                1041,
                1053,
                1056,
                1057,
                1059,
                1060,
                1061,
                1064,
                1067,
                1070,
                1071,
                1072,
                1073,
                1074,
                1077,
                1078,
                1079,
                1083,
                1084,
                1085,
                1097,
                1098,
                1099,
                1109,
                1110,
                1111,
                1112,
                1113,
                1114,
                1115,
                1116,
                1117,
                1118,
                1119,
                1120,
                1121,
                1123,
                1124,
                1125,
                1130,
                1142,
                1144,
                1146,
                1148,
                1150,
                1151,
                1153,
                1155,
                1157,
                1161,
                1163,
                1165,
                1167,
                1169,
                1171,
                1173,
                1175,
                1177,
                1179,
                1181,
                1182,
                1184,
                1186,
                1188,
                1190,
                1192,
                1193,
                1355,
                1356,
                1361,
                2,
                1363,
                1365,
                1,
              ],
              "id": 76,
              "path": "node_modules/react/index.js",
            },
            {
              "dependencies": [
                21,
                35,
                338,
                342,
                381,
                382,
                452,
                390,
                391,
                393,
                394,
                398,
                403,
                340,
                406,
                285,
                400,
                407,
                410,
                413,
                377,
                415,
                419,
                420,
                378,
                379,
                421,
                266,
                422,
                423,
                425,
                151,
                380,
                170,
                453,
                184,
                426,
                428,
                429,
                161,
                213,
                292,
                247,
                271,
                290,
                327,
                325,
                432,
                79,
                150,
                138,
                133,
                434,
                436,
                214,
                438,
                191,
                440,
                267,
                32,
                441,
                41,
                231,
                442,
                445,
                446,
                73,
                448,
                449,
                127,
                450,
                158,
                40,
                60,
                165,
                167,
                277,
                268,
                376,
              ],
              "dependents": [
                454,
                463,
                464,
                465,
                515,
                518,
                548,
                567,
                624,
                633,
                636,
                637,
                638,
                648,
                656,
                658,
                659,
                660,
                674,
                675,
                682,
                683,
                774,
                777,
                779,
                792,
                793,
                807,
                808,
                809,
                811,
                812,
                814,
                815,
                816,
                899,
                900,
                904,
                907,
                987,
                995,
                996,
                1001,
                1002,
                1003,
                1005,
                1006,
                1007,
                1008,
                1009,
                1010,
                1011,
                1012,
                1013,
                1014,
                1016,
                1017,
                1028,
                1031,
                1032,
                1033,
                1034,
                1035,
                1038,
                1039,
                1041,
                1042,
                1047,
                1048,
                1049,
                1050,
                1051,
                1053,
                1054,
                1056,
                1059,
                1060,
                1061,
                1064,
                1067,
                1071,
                1072,
                1073,
                1074,
                1083,
                1085,
                1095,
                1100,
                1109,
                1110,
                1112,
                1113,
                1114,
                1115,
                1116,
                1117,
                1118,
                1127,
                1128,
                1129,
                1130,
                1132,
                1138,
                1160,
                1161,
                1171,
                1177,
                1356,
                2,
                1363,
                0,
              ],
              "id": 451,
              "path": "node_modules/react-native/index.js",
            },
            {
              "dependencies": [
                515,
                517,
                519,
                520,
              ],
              "dependents": [
                1060,
                1073,
                1074,
                1084,
                1118,
                2,
                1,
              ],
              "id": 521,
              "path": "node_modules/react-native-safe-area-context/src/index.tsx",
            },
            {
              "dependencies": [
                1045,
              ],
              "dependents": [
                1123,
                1125,
                2,
                1363,
                1369,
                1,
              ],
              "id": 1046,
              "path": "node_modules/dripsy/src/index.ts",
            },
            {
              "dependencies": [
                1123,
                1124,
                1125,
              ],
              "dependents": [
                2,
                1363,
              ],
              "id": 1126,
              "path": "src/components/index.ts",
            },
            {
              "dependencies": [
                76,
                1360,
                669,
              ],
              "dependents": [
                2,
              ],
              "id": 1361,
              "path": "src/assets/logo.svg",
            },
          ]
        `);
    });
  });

  describe('reset', () => {
    let graph: DependencyGraph;

    beforeAll(async () => {
      const rawMetafile = await readFile(
        join(__dirname, './fixtures/metafile.json'),
        'utf-8',
      );
      graph = new DependencyGraph().load(rawMetafile);
    });

    it('should reset dependency graph', () => {
      graph.reset();

      expect(() =>
        graph.getModule('src/screens/MainScreen.tsx'),
      ).toThrowError();
    });
  });

  describe('when `root` path is provided', () => {
    let graph: DependencyGraph;
    const ROOT = '/root/workspace';

    beforeAll(async () => {
      const rawMetafile = await readFile(
        join(__dirname, './fixtures/metafile.json'),
        'utf-8',
      );
      graph = new DependencyGraph({ root: ROOT }).load(rawMetafile);
    });

    it('should able to get the module by its absolute path', () => {
      // Relative
      expect(() =>
        graph.getModule('../node_modules/@swc/helpers/esm/_instanceof.js'),
      ).not.toThrowError();
      expect(() =>
        graph.getModule('src/components/Button.tsx'),
      ).not.toThrowError();

      // Absolute
      expect(() =>
        graph.getModule('/root/workspace/src/components/Button.tsx'),
      ).not.toThrowError();
      expect(() =>
        graph.getModule('/root/node_modules/@swc/helpers/esm/_instanceof.js'),
      ).not.toThrowError();
    });
  });
});
